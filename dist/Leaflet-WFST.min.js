/*! Leaflet-WFST 0.0.1 2015-02-26 */
L.Filter.GmlObjectID=L.Filter.extend({feature:{},initialize:function(a){this.feature=a},innerGml:function(){return L.XmlUtil.createElementNS("ogc:GmlObjectId",{"gml:id":this.feature.id})}}),L.Filter=L.Class.extend({toGml:function(){var a=L.XmlUtil.createElementNS("ogc:Filter");return a.appendChild(this.innerGml()),a},innerGml:function(){return document.createTextNode("")}}),L.Format.GML=L.Format.extend({}),L.Format.GeoJSON=L.Format.extend({initialize:function(a){L.Format.prototype.initialize.call(this,a),this.requestParams=L.extend(this.requestParams,{outputFormat:"application/json"})},responseToLayers:function(a,b){for(var c=[],d=JSON.parse(a),e=0;e<d.features.length;e++){var f=L.GeoJSON.geometryToLayer(d.features[e],null,b,null);f.feature=d.features[e],c.push(f)}return c}}),L.Format=L.Class.extend({requestParams:{},defaultOptions:{crs:L.CRS.EPSG3857,coordsToLatLng:function(a){return new L.LatLng(a[1],a[0],a[2])},latLngToCoords:function(a){var b=[a.lng,a.lat];return void 0!==a.alt&&b.push(a.alt),b}},setCRS:function(a){this.options.crs=a,void 0!==a&&(this.options.coordsToLatLng=function(b){var c=L.point(b[0],b[1]);return a.projection.unproject(c)},this.options.latLngToCoords=function(b){var c=new L.latLng(b[0],b[1]);return a.projection.project(c)})},initialize:function(a){L.setOptions(this,L.extend(this.defaultOptions,a))}}),L.Marker.include({toGml:function(a){var b=L.XmlUtil.createElementNS("gml:Point",{srsName:a.code});return b.appendChild(L.GMLUtil.posNode(L.Util.project(a,this.getLatLng()))),b}}),L.Polygon.include({toGml:function(a){var b=L.XmlUtil.createElementNS("gml:Polygon",{srsName:a.code,srsDimension:2});if(b.appendChild(L.XmlUtil.createElementNS("gml:exterior")).appendChild(L.XmlUtil.createElementNS("gml:LinearRing",{srsDimension:2})).appendChild(L.GMLUtil.posListNode(L.Util.project(a,this.getLatLngs()),!0)),this._holes&&this._holes.length)for(var c in this._holes)b.appendChild(L.XmlUtil.createElementNS("gml:interior")).appendChild(L.XmlUtil.createElementNS("gml:LinearRing",{srsDimension:2})).appendChild(L.GMLUtil.posListNode(L.Util.project(a,this._holes[c]),!0));return b}}),L.GMLUtil={posNode:function(a){return L.XmlUtil.createElementNS("gml:pos",{srsDimension:2},{value:a.x+" "+a.y})},posListNode:function(a,b){var c=[];if(a.forEach(function(a){c.push(a.x+" "+a.y)}),b){var d=a[0];c.push(d.x+" "+d.y)}var e=c.join(" ");return L.XmlUtil.createElementNS("gml:posList",{},{value:e})}},L.Util.request=function(a){a=L.extend({async:!0,method:"POST",data:"",params:{},headers:{},url:window.location.href,success:function(a){console.log(a)},error:function(a){console.log("Ajax fail"),console.log(a)}},a);var b=new XMLHttpRequest;b.onreadystatechange=function(){4===b.readyState&&(200===b.status?a.success(b.responseText):a.error(b.responseText))};var c=a.url+L.Util.getParamString(a.params,a.url);b.open(a.method,c,a.async);for(var d in a.headers)b.setRequestHeader(d,a.headers[d]);b.send(a.data)},L.Util.project=function(a,b){if(L.Util.isArray(b)){var c=[];return b.forEach(function(b){c.push(a.projection.project(b))}),c}return a.projection.project(b)},L.WFS.Transaction.include({namespaceName:function(a){return this.options.typeNS+":"+a},gmlFeature:function(a){var b=L.XmlUtil.createElementNS(this.requestParams.typeName,{},{uri:this.options.namespaceUri}),c=a.feature;for(var d in c.properties)b.appendChild(this.gmlProperty(d,c.properties[d]));return b.appendChild(this.gmlProperty(this.options.geometryField,a.toGml(this.options.crs))),b},gmlProperty:function(a,b){var c=L.XmlUtil.createElementNS(this.namespaceName(a));return c.appendChild(b instanceof Element?b:L.XmlUtil.createTextNode(b||"")),c},wfsProperty:function(a,b){var c=L.XmlUtil.createElementNS("wfs:Property");c.appendChild(L.XmlUtil.createElementNS("wfs:Name",{},{value:a}));var d=L.XmlUtil.createElementNS("wfs:Value");return d.appendChild(b instanceof Element?b:L.XmlUtil.createTextNode(b||"")),c.appendChild(d),c}}),L.WFS.Transaction.include({insert:function(a){var b=L.XmlUtil.createElementNS("wfs:Insert");return b.appendChild(this.gmlFeature(a)),b},update:function(a){var b=L.XmlUtil.createElementNS("wfs:Update",{typeName:this.requestParams.typeName}),c=a.feature;for(var d in c.properties)b.appendChild(this.wfsProperty(d,c.properties[d]));b.appendChild(this.wfsProperty(this.namespaceName(this.options.geometryField),a.toGml(this.options.crs)));var e=new L.Filter.GmlObjectID(a.feature);return b.appendChild(e.toGml()),b},remove:function(a){var b=L.XmlUtil.createElementNS("wfs:Delete",{typeName:this.requestParams.typeName}),c=new L.Filter.GmlObjectID(a.feature);return b.appendChild(c.toGml()),b},transaction:function(){return L.XmlUtil.createElementNS("wfs:Transaction",{service:"WFS",version:this.options.version})}}),L.WFS.Transaction=L.WFS.extend({changes:{},initialize:function(a,b){L.WFS.prototype.initialize.call(this,a,b),this.changes={},this.describeFeatureType(),this.state=L.extend(this.state,{insert:"insert",update:"update",remove:"remove"})},describeFeatureType:function(){var a=L.extend({},this.requestParams,{request:"DescribeFeatureType"}),b=this;L.Util.request({url:this.options.url,params:a,success:function(a){var c=new DOMParser,d=c.parseFromString(a,"text/xml");b.options.namespaceUri=d.documentElement.attributes.targetNamespace.value}})},addLayer:function(a){if(L.FeatureGroup.prototype.addLayer.call(this,a),a.feature||(a.feature={properties:{}}),!a.state){a.state=this.state.insert;var b=this.getLayerId(a);this.changes[b]=a}return this},removeLayer:function(a){L.FeatureGroup.prototype.removeLayer.call(this,a);var b=this.getLayerId(a);if(b in this.changes){var c=this.changes[b];c.state===this.state.insert?delete this.changes[b]:c.state=this.state.remove}else a.state=this.state.remove,this.changes[b]=a},editLayer:function(a){a.state!==this.state.insert&&(a.state=this.state.update);var b=this.getLayerId(a);return this.changes[b]=a,this},save:function(){var a=this.transaction({version:this.options.version});for(var b in this.changes){var c=this.changes[b],d=this[c.state](c);a.appendChild(d)}return L.Util.request({url:this.options.url,data:L.XmlUtil.createXmlDocumentString(a)}),this.changes={},this}}),L.WFS=L.FeatureGroup.extend({options:{crs:L.CRS.EPSG3857,showExisting:!0,geometryField:"Shape",url:"",version:"1.1.0",typeNS:"",typeName:"",style:{color:"black",weight:1},namespaceUri:""},state:{},initialize:function(a,b){L.setOptions(this,a);var c=this.options.crs;this.state={exist:"exist"},this.options.coordsToLatLng=function(a){var b=L.point(a[0],a[1]);return c.projection.unproject(b)},this.options.latLngToCoords=function(a){var b=c.projection.project(a);return void 0!==a.alt&&b.push(a.alt),b},this._layers={},this.readFormat=b||new L.Format.GeoJSON,this.requestParams=L.extend({service:"WFS",version:this.options.version,typeName:(this.options.typeNS?this.options.typeNS+":":"")+this.options.typeName,srsName:this.options.crs.code},this.options.requestParams),this.options.showExisting&&this.loadFeatures()},loadFeatures:function(){var a=L.extend({},this.requestParams,this.readFormat.requestParams,{request:"GetFeature"}),b=this;L.Util.request({url:this.options.url,params:a,success:function(a){var c=b.readFormat.responseToLayers(a,b.options.coordsToLatLng);return c.forEach(function(a){a.state=b.state.exist,b.addLayer(a)}),b.setStyle(b.options.style),b.fire("load"),b}})}}),L.wfs=function(a,b){return new L.WFS(a,b)},L.XmlUtil={namespaces:{xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs",gml:"http://www.opengis.net/gml",ogc:"http://www.opengis.net/ogc",ows:"http://www.opengis.net/ows",xmlns:"http://www.w3.org/2000/xmlns/"},xmldoc:(new DOMParser).parseFromString("<root />","text/xml"),setAttributes:function(a,b){for(var c in b)if(null!=b[c]&&b[c].toString){var d=b[c].toString(),e=this.namespaces[c.substring(0,c.indexOf(":"))]||null;a.setAttributeNS(e,c,d)}},createElementNS:function(a,b,c){c=c||{};var d=c.uri;d||(d=this.namespaces[a.substring(0,a.indexOf(":"))]),d||(d=this.namespaces[c.prefix]);var e=d?this.xmldoc.createElementNS(d,a):this.xmldoc.createElement(a);return b&&this.setAttributes(e,b),null!=c.value&&e.appendChild(this.xmldoc.createTextNode(c.value)),e},createTextNode:function(a){return this.xmldoc.createTextNode(a)},createXmlDocumentString:function(a){var b=document.implementation.createDocument("","",null);b.appendChild(a);var c=new XMLSerializer;return c.serializeToString(b)},createXmlString:function(a){var b=new XMLSerializer;return b.serializeToString(a)}};