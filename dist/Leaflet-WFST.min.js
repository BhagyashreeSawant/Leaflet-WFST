/*! Leaflet-WFST 0.0.1 2015-06-03 */
!function(a,b,c){"use strict";L.XmlUtil={namespaces:{xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs",gml:"http://www.opengis.net/gml",ogc:"http://www.opengis.net/ogc",ows:"http://www.opengis.net/ows",xmlns:"http://www.w3.org/2000/xmlns/"},xmldoc:(new DOMParser).parseFromString("<root />","text/xml"),setAttributes:function(a,b){for(var c in b)if(null!=b[c]&&b[c].toString){var d=b[c].toString(),e=this.namespaces[c.substring(0,c.indexOf(":"))]||null;a.setAttributeNS(e,c,d)}},evaluate:function(a,b){var c=new DOMParser,d=c.parseFromString(b,"text/xml"),e=new XPathEvaluator,f=e.createNSResolver(d.documentElement);return e.evaluate(a,d,f,XPathResult.ANY_TYPE,null)},createElementNS:function(a,b,c){c=c||{};var d=c.uri;d||(d=this.namespaces[a.substring(0,a.indexOf(":"))]),d||(d=this.namespaces[c.prefix]);var e=d?this.xmldoc.createElementNS(d,a):this.xmldoc.createElement(a);return b&&this.setAttributes(e,b),null!=c.value&&e.appendChild(this.xmldoc.createTextNode(c.value)),e},createTextNode:function(a){return this.xmldoc.createTextNode(a)},createXmlDocumentString:function(a){var c=b.implementation.createDocument("","",null);c.appendChild(a);var d=new XMLSerializer;return d.serializeToString(c)},createXmlString:function(a){var b=new XMLSerializer;return b.serializeToString(a)}},L.Util.request=function(b){b=L.extend({async:!0,method:"POST",data:"",params:{},headers:{},url:a.location.href,success:function(a){console.log(a)},error:function(a){console.log("Ajax fail"),console.log(a)}},b);var c=new XMLHttpRequest;c.onreadystatechange=function(){4===c.readyState&&(200===c.status?b.success(c.responseText):b.error(c.responseText))};var d=b.url+L.Util.getParamString(b.params,b.url);c.open(b.method,d,b.async);for(var e in b.headers)c.setRequestHeader(e,b.headers[e]);c.send(b.data)},L.Filter=L.Class.extend({initialize:function(){this.filter=L.XmlUtil.createElementNS("ogc:Filter")},toGml:function(){return this.filter},append:function(){return this}}),L.Filter.GmlObjectID=L.Filter.extend({append:function(a){return this.filter.appendChild(L.XmlUtil.createElementNS("ogc:GmlObjectId",{"gml:id":a})),this}}),L.Format=L.Class.extend({defaultOptions:{crs:L.CRS.EPSG3857,coordsToLatLng:function(a){return new L.LatLng(a[1],a[0],a[2])},latLngToCoords:function(a){var b=[a.lng,a.lat];return a.alt!==c&&b.push(a.alt),b}},setCRS:function(a){this.options.crs=a,a!==c&&(this.options.coordsToLatLng=function(b){var c=L.point(b[0],b[1]);return a.projection.unproject(c)},this.options.latLngToCoords=function(b){var c=new L.latLng(b[0],b[1]);return a.projection.project(c)})},initialize:function(a){L.setOptions(this,L.extend(this.defaultOptions,a))}}),L.Format.GeoJSON=L.Format.extend({initialize:function(a){L.Format.prototype.initialize.call(this,a),this.outputFormat="application/json"},responseToLayers:function(a){a=a||{};for(var b=[],c=JSON.parse(a.rawData),d=0;d<c.features.length;d++){var e=L.GeoJSON.geometryToLayer(c.features[d],a.pointToLayer||null,a.coordsToLatLng,null);e.feature=c.features[d],b.push(e)}return b}}),L.Format.GML=L.Format.extend({}),L.Util.project=function(a,b){if(L.Util.isArray(b)){var c=[];return b.forEach(function(b){c.push(a.projection.project(b))}),c}return a.projection.project(b)},L.GMLUtil={posNode:function(a){return L.XmlUtil.createElementNS("gml:pos",{srsDimension:2},{value:a.x+" "+a.y})},posListNode:function(a,b){var c=[];if(a.forEach(function(a){c.push(a.x+" "+a.y)}),b&&a.length>0){var d=a[0];c.push(d.x+" "+d.y)}var e=c.join(" ");return L.XmlUtil.createElementNS("gml:posList",{},{value:e})}},L.Marker.include({toGml:function(a){var b=L.XmlUtil.createElementNS("gml:Point",{srsName:a.code});return b.appendChild(L.GMLUtil.posNode(L.Util.project(a,this.getLatLng()))),b}}),L.MultiPolygon.include({toGml:function(a){var b=L.XmlUtil.createElementNS("gml:MultiPolygon",{srsName:a.code,srsDimension:2}),c=b.appendChild(L.XmlUtil.createElementNS("gml:polygonMembers"));return this.eachLayer(function(b){c.appendChild(b.toGml(a))}),b}}),L.MultiPolyline.include({toGml:function(a){var b=L.XmlUtil.createElementNS("gml:MultiLineString",{srsName:a.code,srsDimension:2}),c=b.appendChild(L.XmlUtil.createElementNS("gml:lineStringMembers"));return this.eachLayer(function(b){c.appendChild(b.toGml(a))}),b}}),L.Polygon.include({toGml:function(a){var b=L.XmlUtil.createElementNS("gml:Polygon",{srsName:a.code,srsDimension:2});if(b.appendChild(L.XmlUtil.createElementNS("gml:exterior")).appendChild(L.XmlUtil.createElementNS("gml:LinearRing",{srsDimension:2})).appendChild(L.GMLUtil.posListNode(L.Util.project(a,this.getLatLngs()),!0)),this._holes&&this._holes.length)for(var c in this._holes)b.appendChild(L.XmlUtil.createElementNS("gml:interior")).appendChild(L.XmlUtil.createElementNS("gml:LinearRing",{srsDimension:2})).appendChild(L.GMLUtil.posListNode(L.Util.project(a,this._holes[c]),!0));return b}}),L.Polyline.include({toGml:function(a){var b=L.XmlUtil.createElementNS("gml:LineString",{srsName:a.code,srsDimension:2});return b.appendChild(L.GMLUtil.posListNode(L.Util.project(a,this.getLatLngs()),!0)),b}}),L.WFS=L.FeatureGroup.extend({options:{crs:L.CRS.EPSG3857,showExisting:!0,geometryField:"Shape",url:"",version:"1.1.0",typeNS:"",typeName:"",typeNSName:"",style:{color:"black",weight:1},namespaceUri:""},state:{},initialize:function(a,b){L.setOptions(this,a);var d=this.options.crs;this.state={exist:"exist"},this.options.coordsToLatLng=function(a){var b=L.point(a[0],a[1]);return d.projection.unproject(b)},this.options.latLngToCoords=function(a){var b=d.projection.project(a);return a.alt!==c&&b.push(a.alt),b},this._layers={},this.readFormat=b||new L.Format.GeoJSON,this.options.typeNSName=this.namespaceName(this.options.typeName),this.options.srsName=this.options.crs.code,this.options.showExisting&&this.loadFeatures()},namespaceName:function(a){return this.options.typeNS+":"+a},getFeature:function(a){var b=L.XmlUtil.createElementNS("wfs:GetFeature",{service:"WFS",version:this.options.version,outputFormat:this.readFormat.outputFormat}),c=b.appendChild(L.XmlUtil.createElementNS("wfs:Query",{typeName:this.options.typeNSName,srsName:this.options.srsName}));return a&&a.toGml&&c.appendChild(a.toGml()),b},loadFeatures:function(a){var b=this;L.Util.request({url:this.options.url,data:L.XmlUtil.createXmlDocumentString(b.getFeature(a)),success:function(a){var c=b.readFormat.responseToLayers({rawData:a,coordsToLatLng:b.options.coordsToLatLng,pointToLayer:b.options.pointToLayer});return c.forEach(function(a){a.state=b.state.exist,b.addLayer(a)}),b.setStyle(b.options.style),b.fire("load"),b}})}}),L.wfs=function(a,b){return new L.WFS(a,b)},L.WFS.Transaction=L.WFS.extend({initialize:function(a,b){L.WFS.prototype.initialize.call(this,a,b),this.describeFeatureType(),this.state=L.extend(this.state,{insert:"insert",update:"update",remove:"remove"}),this.changes={};var c=this;this.on("save:success",function(){c.changes={}})},describeFeatureType:function(){var a=L.XmlUtil.createElementNS("wfs:DescribeFeatureType",{service:"WFS",version:this.options.version});a.appendChild(L.XmlUtil.createElementNS("TypeName",{},{value:this.options.typeNSName}));var b=this;L.Util.request({url:this.options.url,data:L.XmlUtil.createXmlDocumentString(a),success:function(a){var c=new DOMParser,d=c.parseFromString(a,"text/xml").documentElement;b.options.namespaceUri=d.attributes.targetNamespace.value}})},addLayer:function(a){if(L.FeatureGroup.prototype.addLayer.call(this,a),a.feature||(a.feature={properties:{}}),!a.state){a.state=this.state.insert;var b=this.getLayerId(a);this.changes[b]=a}return this},removeLayer:function(a){L.FeatureGroup.prototype.removeLayer.call(this,a);var b=this.getLayerId(a);if(b in this.changes){var c=this.changes[b];c.state===this.state.insert?delete this.changes[b]:c.state=this.state.remove}else a.state=this.state.remove,this.changes[b]=a},editLayer:function(a){a.state!==this.state.insert&&(a.state=this.state.update);var b=this.getLayerId(a);return this.changes[b]=a,this},save:function(){var a=L.XmlUtil.createElementNS("wfs:Transaction",{service:"WFS",version:this.options.version}),b=[];for(var c in this.changes){var d=this.changes[c],e=this[d.state](d);a.appendChild(e),d.state===this.state.insert&&b.push(d)}var f=this;return L.Util.request({url:this.options.url,data:L.XmlUtil.createXmlDocumentString(a),success:function(a){for(var c=L.XmlUtil.evaluate("//wfs:InsertResults/wfs:Feature/ogc:FeatureId/@fid",a),d=new L.Filter.GmlObjectID,e=c.iterateNext();e;)d.append(e.value),e=c.iterateNext();b.forEach(function(a){L.FeatureGroup.prototype.removeLayer.call(f,a)}),f.once("load",function(){f.fire("save:success")}),f.loadFeatures(d)}}),this}}),L.WFS.Transaction.include({gmlFeature:function(a){var b=L.XmlUtil.createElementNS(this.options.typeNSName,{},{uri:this.options.namespaceUri}),c=a.feature;for(var d in c.properties)b.appendChild(this.gmlProperty(d,c.properties[d]));return b.appendChild(this.gmlProperty(this.options.geometryField,a.toGml(this.options.crs))),b},gmlProperty:function(a,b){var c=L.XmlUtil.createElementNS(this.namespaceName(a));return c.appendChild(b instanceof Element?b:L.XmlUtil.createTextNode(b||"")),c},wfsProperty:function(a,b){var c=L.XmlUtil.createElementNS("wfs:Property");c.appendChild(L.XmlUtil.createElementNS("wfs:Name",{},{value:a}));var d=L.XmlUtil.createElementNS("wfs:Value");return d.appendChild(b instanceof Element?b:L.XmlUtil.createTextNode(b||"")),c.appendChild(d),c}}),L.WFS.Transaction.include({insert:function(a){var b=L.XmlUtil.createElementNS("wfs:Insert");return b.appendChild(this.gmlFeature(a)),b},update:function(a){var b=L.XmlUtil.createElementNS("wfs:Update",{typeName:this.options.typeNSName}),c=a.feature;for(var d in c.properties)b.appendChild(this.wfsProperty(d,c.properties[d]));b.appendChild(this.wfsProperty(this.namespaceName(this.options.geometryField),a.toGml(this.options.crs)));var e=(new L.Filter.GmlObjectID).append(a.feature.id);return b.appendChild(e.toGml()),b},remove:function(a){var b=L.XmlUtil.createElementNS("wfs:Delete",{typeName:this.options.typeNSName}),c=(new L.Filter.GmlObjectID).append(a.feature.id);return b.appendChild(c.toGml()),b}})}(window,document);